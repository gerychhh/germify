{% extends "core/base.html" %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'core/css/pages/messages/messages.css' %}?v=1">
{% endblock %}

{% block title %}Настройки группы — Germify{% endblock %}

{% block content %}
<div class="row g-3 messages-layout">

    <div class="col-12 col-lg-4">
        <div class="card messages-sidebar-card d-flex flex-column">
            <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <span class="fw-semibold">Сообщения</span>
                <a href="{% url 'messages_chat' chat.id %}" class="btn btn-sm btn-outline-secondary" style="padding: 2px 10px; border-radius: 999px; line-height: 1;">Назад</a>
            </div>

            <div class="p-2">
                <input type="text"
                       class="form-control form-control-sm"
                       placeholder="Поиск по диалогам…"
                       id="dialogs-search">
            </div>

            <div class="flex-grow-1 overflow-auto"
                 id="dialogs-wrapper"
                 data-poll-url="{% url 'messages_inbox_poll' %}">
                {% include "core/partials/messages_inbox_list.html" with threads=threads %}
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-8">
        <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="h5 mb-0">Настройки группы</div>
                <a href="{% url 'messages_chat' chat.id %}" class="btn btn-sm btn-outline-secondary" style="padding: 2px 10px; border-radius: 999px; line-height: 1;">К чату</a>
            </div>

            {% if can_manage %}
                <form method="post" action="{% url 'messages_chat_rename' chat.id %}" class="d-flex flex-column gap-2">
                    {% csrf_token %}
                    <div>
                        <label class="form-label">Название</label>
                        <input type="text" name="title" class="form-control" value="{{ chat.title|default:'' }}" maxlength="255" required>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Сохранить название</button>
                    </div>
                </form>

                <div class="mt-3">
                    <label class="form-label">Аватар группы</label>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        {% include "core/partials/avatar.html" with user_obj=chat size="md" %}
                        <form method="post"
                              action="{% url 'messages_chat_avatar_update' chat.id %}"
                              enctype="multipart/form-data"
                              class="d-flex align-items-center gap-2">
                            {% csrf_token %}
                            <input type="file" name="avatar" accept="image/*" class="form-control" style="max-width: 340px;">
                            <button type="submit" class="btn btn-outline-primary">Загрузить</button>
                            {% if chat.avatar %}
                                <button type="submit" name="remove" value="1" class="btn btn-outline-danger">Удалить</button>
                            {% endif %}
                        </form>
                    </div>
                    <div class="form-text">PNG/JPG/WebP, до 10MB</div>
                </div>
            {% else %}
                <div class="alert alert-light border mb-0">
                    Здесь отображаются участники чата. Менять название и состав может только владелец/админ.
                </div>
            {% endif %}

            <hr class="my-4">

            <div class="h6 mb-2">Участники</div>
            <div class="border rounded-3 p-2" style="max-height: 260px; overflow: auto;">
                {% for item in members %}
                    <div class="dialog-item mb-1" style="cursor: default;">
                        <div class="d-flex align-items-center gap-2" style="min-width: 0;">
                            {% include "core/partials/avatar.html" with user_obj=item.user size="sm" %}
                            <div class="dialog-main" style="min-width: 0;">
                                <div class="dialog-username text-truncate">
                                    {{ item.user.display_name|default:item.user.username }}
                                    {% if item.user.id == request.user.id %}<span class="text-body-secondary small">(вы)</span>{% endif %}
                                </div>
                                <div class="dialog-last-line">
                                    <span class="text-body-secondary">@{{ item.user.username }}</span>
                                    <span class="text-body-secondary">•</span>
                                    <span class="text-body-secondary small">
                                        {% if item.m.role == "owner" %}владелец{% elif item.m.role == "admin" %}админ{% else %}участник{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>

                        {% if item.can_remove and can_manage %}
                            <form method="post" action="{% url 'messages_chat_members_remove' chat.id item.user.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger" style="padding: 2px 10px; border-radius: 999px; line-height: 1;">Удалить</button>
                            </form>
                        {% else %}
                            <div style="width: 74px;"></div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            {% if can_manage %}
                <div class="h6 mt-4 mb-2">Добавить участников</div>
                {% if dm_contacts %}
                    <form method="post" action="{% url 'messages_chat_members_add' chat.id %}">
                        {% csrf_token %}
                        <input type="text" class="form-control form-control-sm mb-2" id="members-search" placeholder="Поиск по вашим диалогам…">
                        <div class="border rounded-3 p-2" style="max-height: 340px; overflow: auto;">
                            {% for u in dm_contacts %}
                                <label class="dialog-item mb-1 member-pick-item" style="cursor: pointer;" data-search="{{ u.display_name|default:u.username }} @{{ u.username }}">
                                    <div class="d-flex align-items-center gap-2" style="min-width: 0;">
                                        {% include "core/partials/avatar.html" with user_obj=u size="sm" %}
                                        <div class="dialog-main" style="min-width: 0;">
                                            <div class="dialog-username text-truncate">{{ u.display_name|default:u.username }}</div>
                                            <div class="dialog-last-line"><span class="text-body-secondary">@{{ u.username }}</span></div>
                                        </div>
                                    </div>
                                    <input class="form-check-input" type="checkbox" name="members_ids" value="{{ u.id }}" style="margin-left:auto;">
                                </label>
                            {% endfor %}
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <button type="submit" class="btn btn-primary">Добавить</button>
                            <a href="{% url 'messages_chat' chat.id %}" class="btn btn-light border">Готово</a>
                        </div>
                        <div class="form-text">Список берётся из ваших уже начатых личных диалогов.</div>
                    </form>
                {% else %}
                    <div class="alert alert-light border mb-0">Нет доступных пользователей для добавления (пока что список берётся только из личных диалогов).</div>
                    <div class="mt-2">
                        <a href="{% url 'messages_chat' chat.id %}" class="btn btn-light border">Готово</a>
                    </div>
                {% endif %}
            {% else %}
                <div class="mt-3">
                    <a href="{% url 'messages_chat' chat.id %}" class="btn btn-light border">Готово</a>
                </div>
            {% endif %}
        </div>
    </div>

</div>

<script>
(function(){
  const input = document.getElementById("members-search");
  if(!input) return;
  input.addEventListener("input", function(){
    const q = (input.value || "").trim().toLowerCase();
    document.querySelectorAll(".member-pick-item").forEach(function(item){
      const hay = (item.dataset.search || "").toLowerCase();
      item.style.display = (!q || hay.includes(q)) ? "" : "none";
    });
  });
})();
</script>
{% endblock %}