{# core/partials/message_item.html #}
{% load tz %}

<div class="message-item {% if message.sender == request.user %}me{% else %}other{% endif %}" data-id="{{ message.id }}">

    {% if message.sender == request.user %}
        <div class="message-body">
    {% else %}
        {% include "core/partials/avatar.html" with user_obj=message.sender size="sm" %}
        <div class="message-body">
    {% endif %}

        {# =================== –í–õ–û–ñ–ï–ù–ò–Ø (–∫–∞–∫ –≤ –ø–æ—Å—Ç–∞—Ö) =================== #}
        {% if message.attachments.all %}
        <div class="attachments message-attachments">

            {# –ö–ê–†–¢–ò–ù–ö–ò ‚Äî —Å–µ—Ç–∫–∞ #}
            <div class="attachment-gallery" data-count="{{ message.attachments.all|length }}">
                {% for att in message.attachments.all %}
                    {% if att.is_image %}
                        <div class="gallery-item">
                            <img src="{{ att.file.url }}"
                                 alt="{{ att.original_name }}"
                                 class="gallery-img"
                                 data-full="{{ att.file.url }}">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            {# –í–ò–î–ï–û #}
            <div class="attachment-videos">
                {% for att in message.attachments.all %}
                    {% with name=att.original_name|lower %}
                        {% if ".mp4" in name or ".mov" in name %}
                            <div class="video-wrapper">
                                <div class="video-inner">
                                    <video class="video-player" preload="metadata">
                                        <source src="{{ att.file.url }}">
                                    </video>
                                </div>
                                <div class="video-controls">
                                    <button type="button" class="video-btn video-play">‚ñ∂</button>

                                    <div class="video-progress-bar">
                                        <div class="video-buffer"></div>
                                        <div class="video-progress"></div>
                                    </div>

                                    <div class="video-time">
                                        <span class="video-current">0:00</span> /
                                        <span class="video-duration">0:00</span>
                                    </div>

                                    <button type="button" class="video-btn video-mute">üîä</button>
                                    <button type="button" class="video-btn video-fullscreen">‚õ∂</button>

                                    <a href="{{ att.file.url }}" download class="video-btn video-download" title="–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ">‚§ì</a>
                                </div>
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>

            {# –ê–£–î–ò–û (mp3/wav/ogg/webm) ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–ª–µ–µ—Ä #}
            <div class="attachment-audios">
                {% for att in message.attachments.all %}
                    {% with name=att.original_name|lower %}
                        {% if ".mp3" in name or ".wav" in name or ".ogg" in name or ".webm" in name %}
                            <div class="audio-wrapper">

                                <audio class="audio-player">
                                    <source src="{{ att.file.url }}">
                                </audio>

                                <div class="audio-controls">
                                    <button type="button" class="audio-play">‚ñ∂</button>

                                    <div class="audio-progress-bar">
                                        <div class="audio-buffer"></div>
                                        <div class="audio-progress"></div>
                                        <input type="range" class="audio-slider" max="100" min="0" value="0" step="0.1">
                                    </div>

                                    <div class="audio-time">
                                        <span class="audio-current">0:00</span> /
                                        <span class="audio-duration">0:00</span>
                                    </div>

                                    <a href="{{ att.file.url }}" download class="audio-download">‚§ì</a>
                                </div>

                                <div class="audio-filename">{{ att.original_name }}</div>

                            </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>

            {# –ü–†–û–ß–ò–ï –§–ê–ô–õ–´ #}
            <div class="attachment-files">
                {% for att in message.attachments.all %}
                    {% with name=att.original_name|lower %}
                        {% if not att.is_image and ".mp3" not in name and ".wav" not in name and ".ogg" not in name and ".webm" not in name and ".mp4" not in name and ".mov" not in name %}
                            <a class="file-card" href="{{ att.file.url }}" download>
                                <div class="file-icon">
                                    {% if ".pdf" in name %}
                                        üìÑ
                                    {% elif ".zip" in name %}
                                        üóúÔ∏è
                                    {% elif ".txt" in name %}
                                        üìÑ
                                    {% elif ".doc" in name or ".docx" in name %}
                                        üìù
                                    {% else %}
                                        üìÅ
                                    {% endif %}
                                </div>
                                <div class="file-name">{{ att.original_name }}</div>
                            </a>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>

        </div>
        {% endif %}

        {% if message.text %}
            <div class="message-text">{{ message.text }}</div>
        {% endif %}

        <div class="message-time">{{ message.created_at|localtime|date:"H:i" }}</div>
    </div>
    {% if message.sender == request.user %}
        {% include "core/partials/avatar.html" with user_obj=message.sender size="sm" %}
    {% endif %}
</div>
