{# core/partials/post.html #}
{% load tz %}

<article class="post-card card shadow-sm" id="post-{{ post.id }}">
    <div class="post-layout card-body p-3">
        <div class="post-main">
            <header class="post-header d-flex justify-content-between align-items-start gap-2">
                <div class="post-author d-flex align-items-center gap-2 flex-wrap">


                    {% if post.is_community_post %}
                        {% include "core/partials/avatar.html" with user_obj=post.community size="md" %}

                        <div class="post-author-meta">
                            <a href="{% url 'community_detail' post.community.slug %}"
                               class="post-author-name text-decoration-none">
                                {{ post.community.name }}
                            </a>
                            <div class="post-author-username">
                                #{{ post.community.slug }}
                            </div>
                            <div class="post-author-username small text-muted" style="margin-top:2px;">
                                –û–ø—É–±–ª–∏–∫–æ–≤–∞–ª:
                                <a href="{% url 'user_profile' post.author.username %}"
                                   class="text-muted text-decoration-none">
                                    @{{ post.author.username }}
                                </a>
                            </div>
                        </div>
                    {% else %}
                        {% include "core/partials/avatar.html" with user_obj=post.author size="md" %}

                        <div class="post-author-meta">
                            <a href="{% url 'user_profile' post.author.username %}"
                               class="post-author-name text-decoration-none">
                                {{ post.author.display_name|default:post.author.username }}
                            </a>
                            <div class="post-author-username">
                                @{{ post.author.username }}
                            </div>

                            {% if post.community %}
                                <div class="post-author-username small text-muted" style="margin-top:2px;">
                                    –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ
                                    <a href="{% url 'community_detail' post.community.slug %}"
                                       class="text-decoration-none">
                                        {{ post.community.name }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    {# ===== –ö–ù–û–ü–ö–ê –ü–û–î–ü–ò–°–ö–ò –í –ö–ê–†–¢–û–ß–ö–ï –ü–û–°–¢–ê ===== #}
                    {% if user.is_authenticated and user != post.author and not post.is_community_post %}
                        <div class="ms-2">
                            {% if post.author.id in following_ids %}
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary follow-btn py-0 px-2"
                                        data-username="{{ post.author.username }}"
                                        data-following="1"
                                        data-follow-url="{% url 'follow_user' post.author.username %}"
                                        data-unfollow-url="{% url 'unfollow_user' post.author.username %}">
                                    –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã
                                </button>
                            {% else %}
                                <button type="button"
                                        class="btn btn-sm btn-primary follow-btn py-0 px-2"
                                        data-username="{{ post.author.username }}"
                                        data-following="0"
                                        data-follow-url="{% url 'follow_user' post.author.username %}"
                                        data-unfollow-url="{% url 'unfollow_user' post.author.username %}">
                                    –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <div class="post-header-right d-flex align-items-center gap-2">
                    <a href="{% url 'post_detail' post.id %}"
                       class="post-date small">
                        {{ post.created_at|date:"d.m.Y H:i" }}
                    </a>

                    <div class="post-menu-wrapper position-relative">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary post-menu-toggle"
                                data-post-id="{{ post.id }}">
                            ‚ãØ
                        </button>

                        <div class="post-menu hidden"
                             data-post-id="{{ post.id }}">

                            <button type="button"
                                    class="post-menu-item dropdown-item post-share-btn"
                                    data-post-id="{{ post.id }}"
                                    data-post-url="{% url 'post_detail' post.id %}">
                                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                            </button>

                            {% if user.is_authenticated %}
                                {# ‚úÖ –í–ê–ñ–ù–û: –Ω–∏–∫–∞–∫–∏—Ö —Å–∫–æ–±–æ–∫! Django template –∏—Ö –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç #}
                                {% if user == post.author or user.is_superuser or post.is_community_post and admin_community_ids and post.community_id in admin_community_ids %}

                                    <form method="post"
                                          action="{% url 'delete_post' post.id %}"
                                          class="post-delete-form"
                                          data-post-id="{{ post.id }}">
                                        {% csrf_token %}
                                        <button type="submit"
                                                class="post-menu-item dropdown-item text-danger post-menu-delete-btn">
                                            –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </form>

                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </header>

            {# ==== –¢–ï–ö–°–¢ + –ú–ï–î–ò–ê –° –°–í–Å–†–¢–ö–û–ô ==== #}
            <div class="post-text-block">
                <div class="post-text-wrapper">
                    <p class="post-text">{{ post.text }}</p>

                    {# =================== –í–õ–û–ñ–ï–ù–ò–Ø =================== #}
                    {% if post.attachments.all %}
                    <div class="attachments">

                        {# –ö–ê–†–¢–ò–ù–ö–ò ‚Äî —Å–µ—Ç–∫–∞ #}
                        <div class="attachment-gallery"
                             data-count="{{ post.attachments.all|length }}">
                            {% for att in post.attachments.all %}
                                {% if att.is_image %}
                                    <div class="gallery-item">
                                        <img src="{{ att.file.url }}"
                                             alt="{{ att.original_name }}"
                                             class="gallery-img"
                                             data-full="{{ att.file.url }}">
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        {# –í–ò–î–ï–û ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ –≤–∏–¥–µ–æ (mp4/mov) #}
                        <div class="attachment-videos">
                            {% for att in post.attachments.all %}
                                {% with name=att.original_name|lower %}
                                    {% if ".mp4" in name or ".mov" in name %}
                                        <div class="video-wrapper">
                                            <div class="video-inner">
                                                <video class="video-player" preload="metadata">
                                                    <source src="{{ att.file.url }}">
                                                </video>
                                            </div>
                                            <div class="video-controls">
                                                <button type="button"
                                                        class="video-btn video-play">‚ñ∂</button>

                                                <div class="video-progress-bar">
                                                    <div class="video-buffer"></div>
                                                    <div class="video-progress"></div>
                                                </div>

                                                <div class="video-time">
                                                    <span class="video-current">0:00</span> /
                                                    <span class="video-duration">0:00</span>
                                                </div>

                                                <button type="button"
                                                        class="video-btn video-mute">üîä</button>
                                                <button type="button"
                                                        class="video-btn video-fullscreen">‚õ∂</button>

                                                <a href="{{ att.file.url }}"
                                                   download
                                                   class="video-btn video-download"
                                                   title="–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ">‚§ì</a>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </div>

                        {# –ê–£–î–ò–û (mp3/wav/ogg/webm) ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–ª–µ–µ—Ä #}
                        <div class="attachment-audios">
                            {% for att in post.attachments.all %}
                                {% with name=att.original_name|lower %}
                                    {% if ".mp3" in name or ".wav" in name or ".ogg" in name or ".webm" in name %}
                                        <div class="audio-wrapper">

                                            <audio class="audio-player">
                                                <source src="{{ att.file.url }}">
                                            </audio>

                                            <div class="audio-controls">
                                                <button type="button" class="audio-play">‚ñ∂</button>

                                                <div class="audio-progress-bar">
                                                    <div class="audio-buffer"></div>
                                                    <div class="audio-progress"></div>
                                                    <input type="range"
                                                           class="audio-slider"
                                                           max="100"
                                                           min="0"
                                                           value="0"
                                                           step="0.1">
                                                </div>

                                                <div class="audio-time">
                                                    <span class="audio-current">0:00</span> /
                                                    <span class="audio-duration">0:00</span>
                                                </div>

                                                <a href="{{ att.file.url }}"
                                                   download
                                                   class="audio-download">‚§ì</a>
                                            </div>

                                            <div class="audio-filename">{{ att.original_name }}</div>

                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </div>

                        {# –ü–†–û–ß–ò–ï –§–ê–ô–õ–´ (–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞/–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ) #}
                        <div class="attachment-files">
                            {% for att in post.attachments.all %}
                                {% with name=att.original_name|lower %}
                                    {% if not att.is_image and ".mp3" not in name and ".wav" not in name and ".ogg" not in name and ".webm" not in name and ".mp4" not in name and ".mov" not in name %}
                                        <a class="file-card" href="{{ att.file.url }}" download>
                                            <div class="file-icon">
                                                {% if ".pdf" in name %}
                                                    üìÑ
                                                {% elif ".zip" in name %}
                                                    üóúÔ∏è
                                                {% elif ".txt" in name %}
                                                    üìÑ
                                                {% elif ".doc" in name or ".docx" in name %}
                                                    üìù
                                                {% else %}
                                                    üìÅ
                                                {% endif %}
                                            </div>
                                            <div class="file-name">{{ att.original_name }}</div>
                                        </a>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </div>

                    </div>
                    {% endif %}

                    <div class="post-text-gradient"></div>
                </div>

                <button type="button"
                        class="btn btn-link btn-sm p-0 post-text-toggle hidden">
                    –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
                </button>
            </div>

            <div class="post-footer-row">
                <div class="post-likes">
                    {% if user.is_authenticated %}
                        <form method="post"
                              action="{% url 'toggle_like' post.id %}"
                              class="like-form"
                              data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="like-button{% if post.id in liked_posts_ids %} is-liked{% endif %}"
                                    data-liked="{% if post.id in liked_posts_ids %}true{% else %}false{% endif %}">
                                {% if post.id in liked_posts_ids %}
                                    ‚ù§Ô∏è
                                {% else %}
                                    ü§ç
                                {% endif %}
                            </button>
                        </form>
                    {% endif %}

                    <span class="like-count"
                          data-post-id="{{ post.id }}">
                        {{ post.likes.count }} –ª–∞–π–∫–æ–≤
                    </span>
                </div>
            </div>

            {# ------ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ö –ü–û–°–¢–£ ------ #}
            <div class="comments-wrap">
                <button type="button"
                        class="comments-toggle btn btn-outline-secondary btn-sm w-100"
                        data-post-id="{{ post.id }}">
                    <span class="comments-toggle-label">
                        üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        <span class="comments-count-badge">{{ post.comments.count }}</span>
                    </span>
                    <span class="comments-toggle-arrow">‚ñæ</span>
                </button>
                {% if user.is_authenticated %}
                        <button type="button"
                                class="comment-add-toggle btn btn-outline-primary btn-sm mt-2"
                                data-post-id="{{ post.id }}">
                            –ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>

                        <form method="post"
                              action="{% url 'add_comment' post.id %}"
                              class="comment-form hidden mt-2"
                              data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <textarea name="text"
                                      class="form-control comment-input mb-2"
                                      placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."
                                      rows="2"
                                      required></textarea>
                            <button type="submit"
                                    class="btn btn-primary btn-sm comment-btn">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </form>
                    {% endif %}
                <div class="comments-body hidden"
                     data-post-id="{{ post.id }}">

                    {% for c in post.comments.all %}
                        {% if not c.parent %}
                            {% include "core/partials/comment.html" with c=c user=user liked_comment_ids=liked_comment_ids level=0 %}
                        {% endif %}
                    {% endfor %}


                </div>
            </div>

        </div>
    </div>
</article>
