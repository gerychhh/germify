{# core/partials/post.html #}
{% load tz markdown_extras %}

<article class="post-card card shadow-sm border rounded-4 bg-body" id="post-{{ post.id }}">
  <div class="post-layout card-body p-3 d-flex align-items-start gap-2">
    <div class="post-main w-100">

      <!-- ===================== HEADER ===================== -->
      <header class="post-header d-flex justify-content-between align-items-start gap-2 w-100">
        <div class="post-author d-flex align-items-center gap-2 flex-wrap">

          {% if post.is_community_post %}
            {% include "core/partials/avatar.html" with user_obj=post.community size="md" %}

            <div class="post-author-meta">
              <a href="{% url 'community_detail' post.community.slug %}"
                 class="post-author-name text-decoration-none">
                {{ post.community.name }}
              </a>
              <div class="post-author-username">
                #{{ post.community.slug }}
              </div>
              <div class="post-author-username small text-muted" style="margin-top:2px;">
                –û–ø—É–±–ª–∏–∫–æ–≤–∞–ª:
                <a href="{% url 'user_profile' post.author.username %}"
                   class="text-muted text-decoration-none">
                  @{{ post.author.username }}
                </a>
              </div>
            </div>
          {% else %}
            {% include "core/partials/avatar.html" with user_obj=post.author size="md" %}

            <div class="post-author-meta">
              <a href="{% url 'user_profile' post.author.username %}"
                 class="post-author-name text-decoration-none">
                {{ post.author.display_name|default:post.author.username }}
              </a>
              <div class="post-author-username">
                @{{ post.author.username }}
              </div>

              {% if post.community %}
                <div class="post-author-username small text-muted" style="margin-top:2px;">
                  –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ
                  <a href="{% url 'community_detail' post.community.slug %}"
                     class="text-decoration-none">
                    {{ post.community.name }}
                  </a>
                </div>
              {% endif %}
            </div>
          {% endif %}

          {% if user.is_authenticated and user != post.author and not post.is_community_post %}
            <div class="ms-2">
              {% if post.author.id in following_ids %}
                <button type="button"
                        class="btn btn-sm btn-outline-secondary follow-btn py-0 px-2"
                        data-username="{{ post.author.username }}"
                        data-following="1"
                        data-follow-url="{% url 'follow_user' post.author.username %}"
                        data-unfollow-url="{% url 'unfollow_user' post.author.username %}">
                  –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã
                </button>
              {% else %}
                <button type="button"
                        class="btn btn-sm btn-primary follow-btn py-0 px-2"
                        data-username="{{ post.author.username }}"
                        data-following="0"
                        data-follow-url="{% url 'follow_user' post.author.username %}"
                        data-unfollow-url="{% url 'unfollow_user' post.author.username %}">
                  –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                </button>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="post-header-right d-flex align-items-center gap-2 ms-sm-auto">
          <a href="{% url 'post_detail' post.id %}" class="post-date small">
            {{ post.created_at|date:"d.m.Y H:i" }}
          </a>

          {% if user.is_authenticated %}
            {% if user == post.author or user.is_superuser or post.is_community_post and post.community_id in admin_community_ids %}
              <button type="button"
                      class="btn btn-sm btn-outline-secondary post-edit-toggle"
                      data-post-id="{{ post.id }}"
                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                ‚úé
              </button>
            {% endif %}
          {% endif %}

          <div class="post-menu-wrapper position-relative">
            <button type="button"
                    class="btn btn-sm btn-outline-secondary post-menu-toggle"
                    data-post-id="{{ post.id }}">
              ‚ãØ
            </button>

            <div class="post-menu hidden" data-post-id="{{ post.id }}">
              <button type="button"
                      class="post-menu-item dropdown-item post-share-btn"
                      data-post-id="{{ post.id }}"
                      data-post-url="{% url 'post_detail' post.id %}">
                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
              </button>

              {% if user.is_authenticated %}
                {% if user == post.author or user.is_superuser or post.is_community_post and admin_community_ids and post.community_id in admin_community_ids %}

                  <button type="button"
                          class="post-menu-item dropdown-item post-edit-toggle"
                          data-post-id="{{ post.id }}">
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </button>

                  <div class="dropdown-divider my-1"></div>

                  <form method="post"
                        action="{% url 'delete_post' post.id %}"
                        class="m-0 post-delete-form"
                        data-post-id="{{ post.id }}">
                    {% csrf_token %}
                    <button type="submit"
                            class="post-menu-item dropdown-item post-menu-danger">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                  </form>

                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </header>

      <!-- ===================== VIEW BLOCK (post content) ===================== -->
      <div class="post-view-block w-100">

        <div class="post-text-block">

          {# –í–õ–û–ñ–ï–ù–ò–Ø: –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é #}
          {% if post.attachments.all %}
            <div class="attachments">

              <div class="attachment-gallery w-100" data-count="{{ post.attachments.all|length }}">
                {% for att in post.attachments.all %}
                  {% if att.is_image %}
                    <div class="gallery-item">
                      <img src="{{ att.file.url }}"
                           alt="{{ att.original_name }}"
                           class="gallery-img"
                           data-full="{{ att.file.url }}">
                    </div>
                  {% endif %}
                {% endfor %}
              </div>

              <div class="attachment-videos">
                {% for att in post.attachments.all %}
                  {% with name=att.original_name|lower %}
                    {% if ".mp4" in name or ".mov" in name %}
                      <div class="video-wrapper">
                        <div class="video-inner">
                          <video class="video-player" preload="metadata">
                            <source src="{{ att.file.url }}">
                          </video>
                        </div>
                        <div class="video-controls">
                          <button type="button" class="video-btn video-play">‚ñ∂</button>

                          <div class="video-progress-bar">
                            <div class="video-buffer"></div>
                            <div class="video-progress"></div>
                          </div>

                          <div class="video-time">
                            <span class="video-current">0:00</span> /
                            <span class="video-duration">0:00</span>
                          </div>

                          <button type="button" class="video-btn video-mute">üîä</button>
                          <button type="button" class="video-btn video-fullscreen">‚õ∂</button>

                          <a href="{{ att.file.url }}"
                             download
                             class="video-btn video-download"
                             title="–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ">‚§ì</a>
                        </div>
                      </div>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </div>

              <div class="attachment-audios">
                {% for att in post.attachments.all %}
                  {% with name=att.original_name|lower %}
                    {% if ".mp3" in name or ".wav" in name or ".ogg" in name or ".webm" in name %}
                      <div class="audio-wrapper">
                        <audio class="audio-player">
                          <source src="{{ att.file.url }}">
                        </audio>

                        <div class="audio-controls">
                          <button type="button" class="audio-play">‚ñ∂</button>

                          <div class="audio-progress-bar">
                            <div class="audio-buffer"></div>
                            <div class="audio-progress"></div>
                            <input type="range"
                                   class="audio-slider"
                                   max="100"
                                   min="0"
                                   value="0"
                                   step="0.1">
                          </div>

                          <div class="audio-time">
                            <span class="audio-current">0:00</span> /
                            <span class="audio-duration">0:00</span>
                          </div>

                          <a href="{{ att.file.url }}" download class="audio-download">‚§ì</a>
                        </div>

                        <div class="audio-filename">{{ att.original_name }}</div>
                      </div>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </div>

              <div class="attachment-files">
                {% for att in post.attachments.all %}
                  {% with name=att.original_name|lower %}
                    {% if not att.is_image and ".mp3" not in name and ".wav" not in name and ".ogg" not in name and ".webm" not in name and ".mp4" not in name and ".mov" not in name %}
                      <a class="file-card" href="{{ att.file.url }}" download>
                        <div class="file-icon">
                          {% if ".pdf" in name %}üìÑ
                          {% elif ".zip" in name %}üóúÔ∏è
                          {% elif ".txt" in name %}üìÑ
                          {% elif ".doc" in name or ".docx" in name %}üìù
                          {% else %}üìÅ{% endif %}
                        </div>
                        <div class="file-name">{{ att.original_name }}</div>
                      </a>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </div>

            </div>
          {% endif %}

          {# –¢–ï–ö–°–¢: —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç #}
          <div class="post-text-wrapper">
            <div class="post-text">{{ post.text|md }}</div>
            <div class="post-text-gradient"></div>
          </div>

          <button type="button" class="btn btn-link btn-sm p-0 post-text-toggle hidden">
            –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
          </button>
        </div>

        <div class="post-footer-row d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-2 mt-2">
          <div class="post-likes d-flex align-items-center gap-2">
            {% if user.is_authenticated %}
              <form method="post"
                    action="{% url 'toggle_like' post.id %}"
                    class="like-form"
                    data-post-id="{{ post.id }}">
                {% csrf_token %}
                <button type="submit"
                        class="like-button{% if post.id in liked_posts_ids %} is-liked{% endif %}"
                        data-liked="{% if post.id in liked_posts_ids %}true{% else %}false{% endif %}">
                  {% if post.id in liked_posts_ids %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                </button>
              </form>
            {% endif %}

            <span class="like-count" data-post-id="{{ post.id }}">
              {{ post.likes.count }} –ª–∞–π–∫–æ–≤
            </span>
          </div>
        </div>

        <div class="comments-wrap w-100 mt-2">
          <button type="button"
                  class="comments-toggle btn btn-outline-secondary btn-sm w-100 d-flex align-items-center justify-content-between"
                  data-post-id="{{ post.id }}">
            <span class="comments-toggle-label d-flex align-items-center gap-2">
              <span>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
              <span class="comments-count-badge badge rounded-pill text-bg-light">
                {{ post.comments.count }}
              </span>
            </span>
            <span class="comments-toggle-arrow small text-muted">‚ñæ</span>
          </button>

          {% if user.is_authenticated %}
            <button type="button"
                    class="comment-add-toggle btn btn-outline-primary btn-sm mt-2"
                    data-post-id="{{ post.id }}">
              –ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            </button>

            <form method="post"
                  action="{% url 'add_comment' post.id %}"
                  class="comment-form hidden mt-2"
                  data-post-id="{{ post.id }}">
              {% csrf_token %}
              <textarea name="text"
                        class="form-control comment-input mb-2"
                        placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."
                        rows="2"
                        required></textarea>
              <button type="submit" class="btn btn-primary btn-sm comment-btn">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
              </button>
            </form>
          {% endif %}

          <div class="comments-body hidden" data-post-id="{{ post.id }}">
            {% for c in post.comments.all %}
              {% if not c.parent %}
                {% include "core/partials/comment.html" with c=c user=user liked_comment_ids=liked_comment_ids level=0 %}
              {% endif %}
            {% endfor %}
          </div>
        </div>

      </div>

      <!-- ===================== EDIT BLOCK ===================== -->
      <div class="post-edit-block hidden" data-post-id="{{ post.id }}">
        <form method="post"
              action="{% url 'edit_post' post.id %}"
              class="post-edit-form"
              data-post-id="{{ post.id }}"
              enctype="multipart/form-data">
          {% csrf_token %}

          <textarea name="text"
                    class="form-control post-edit-textarea"
                    rows="4"
                    maxlength="{{ POST_TEXT_MAX_LENGTH }}"
                    data-original="{{ post.text|default_if_none:'' }}">{{ post.text|default_if_none:'' }}</textarea>

          <div class="d-flex justify-content-between align-items-center mt-1">
            <div class="small text-muted">–ú–∞–∫—Å. {{ POST_TEXT_MAX_LENGTH }} —Å–∏–º–≤–æ–ª–æ–≤</div>
            <div class="post-text-counter small text-muted post-edit-counter"></div>
          </div>

          {% if post.attachments.all %}
            <div class="post-edit-existing mt-2">
              <div class="small text-muted mb-1">–¢–µ–∫—É—â–∏–µ –≤–ª–æ–∂–µ–Ω–∏—è</div>
              <div class="post-edit-attachments-list">
                {% for att in post.attachments.all %}
                  <div class="post-edit-attachment-item" data-att-id="{{ att.id }}">
                    {% if att.is_image %}
                      <img src="{{ att.file.url }}" alt="" class="post-edit-att-thumb">
                    {% else %}
                      <div class="post-edit-att-icon">üìé</div>
                    {% endif %}

                    <div class="post-edit-att-name" title="{{ att.original_name }}">
                      {{ att.original_name }}
                    </div>

                    <input type="checkbox"
                           name="delete_attachment_ids"
                           value="{{ att.id }}"
                           class="d-none post-edit-att-check">

                    <button type="button"
                            class="btn btn-sm btn-outline-secondary post-edit-att-toggle"
                            title="–£–±—Ä–∞—Ç—å/–≤–µ—Ä–Ω—É—Ç—å">‚úï</button>
                  </div>
                {% endfor %}
              </div>

              <div class="small text-muted mt-1">
                –ú–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è (‚úï) –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ. –ú–∞–∫—Å. {{ MAX_ATTACHMENTS_PER_POST }} —Ñ–∞–π–ª–æ–≤.
              </div>
            </div>
          {% else %}
            <div class="small text-muted mt-2">
              –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã. –ú–∞–∫—Å. {{ MAX_ATTACHMENTS_PER_POST }} —Ñ–∞–π–ª–æ–≤.
            </div>
          {% endif %}

          <div class="post-edit-new mt-2">
            <input type="file"
                   name="attachments"
                   class="form-control form-control-sm post-edit-file-input"
                   multiple>
            <div class="post-edit-new-files small text-muted mt-1"></div>
          </div>

          <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-outline-secondary btn-sm post-edit-cancel">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </form>
      </div>

    </div>
  </div>
</article>
