{# core/partials/post.html #}
{% load tz %}

<article class="post-card" id="post-{{ post.id }}">
    <div class="post-layout">
        <div class="post-main">
            <header class="post-header">
                <div class="post-author">

                    {% include "core/partials/avatar.html" with user_obj=post.author size="md" %}

                    <div class="post-author-meta">
                        <a href="{% url 'user_profile' post.author.username %}"
                           class="post-author-name">
                            {{ post.author.display_name|default:post.author.username }}
                        </a>
                        <div class="post-author-username">
                            @{{ post.author.username }}
                        </div>
                    </div>

                    {# follow/unfollow –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ #}
                    {% if user.is_authenticated and user != post.author %}
                        <div style="margin-left:8px;">
                            {% if post.author.id in following_ids %}
                                <button type="button"
                                        class="primary-button follow-toggle-btn"
                                        data-username="{{ post.author.username }}"
                                        data-following="true"
                                        style="padding:2px 10px; font-size:12px; background:#1f2937; color:#e5e7eb;">
                                    –í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã
                                </button>
                            {% else %}
                                <button type="button"
                                        class="primary-button follow-toggle-btn"
                                        data-username="{{ post.author.username }}"
                                        data-following="false"
                                        style="padding:2px 10px; font-size:12px;">
                                    –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <div class="post-header-right">
                    {# –¥–∞—Ç–∞ –≤–µ–¥—ë—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ #}
                    <a href="{% url 'post_detail' post.id %}"
                       class="post-date">
                        {{ post.created_at|date:"d.m.Y H:i" }}
                    </a>

                    {# –º–µ–Ω—é –∏–∑ —Ç—Ä—ë—Ö —Ç–æ—á–µ–∫ #}
                    <div class="post-menu-wrapper">
                        <button type="button"
                                class="post-menu-toggle"
                                data-post-id="{{ post.id }}">
                            ‚ãØ
                        </button>

                        <div class="post-menu hidden"
                             data-post-id="{{ post.id }}">
                            <button type="button"
                                    class="post-menu-item post-share-btn"
                                    data-post-id="{{ post.id }}"
                                    data-post-url="{% url 'post_detail' post.id %}">
                                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                            </button>

                            {% if user.is_authenticated %}
                                {% if user == post.author or user.is_superuser %}
                                    <!-- —Ç–≤–æ–π –∫–æ–¥ -->
                                {% endif %}
                            {% endif %}
                                <form method="post"
                                      action="{% url 'delete_post' post.id %}"
                                      class="post-delete-form"
                                      data-post-id="{{ post.id }}">
                                    {% csrf_token %}
                                    <button type="submit"
                                            class="post-menu-item post-menu-delete-btn">
                                        –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </form>
                        </div>
                    </div>
                </div>
            </header>

            <p class="post-text">{{ post.text }}</p>

            <div class="post-footer-row">
                <div class="post-likes">
                    {% if user.is_authenticated %}
                        <form method="post"
                              action="{% url 'toggle_like' post.id %}"
                              class="like-form"
                              data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <button type="submit"
                                    class="like-button{% if post.id in liked_posts_ids %} is-liked{% endif %}"
                                    data-liked="{% if post.id in liked_posts_ids %}true{% else %}false{% endif %}">
                                {% if post.id in liked_posts_ids %}
                                    ‚ù§Ô∏è
                                {% else %}
                                    ü§ç
                                {% endif %}
                            </button>
                        </form>
                    {% endif %}

                    <span class="like-count"
                          data-post-id="{{ post.id }}">
                        {{ post.likes.count }} –ª–∞–π–∫–æ–≤
                    </span>
                </div>
            </div>

            {# ------ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ö –ü–û–°–¢–£ ------ #}
            <div class="comments-wrap">
                <button type="button"
                        class="comments-toggle"
                        data-post-id="{{ post.id }}">
                    <span class="comments-toggle-label">
                        üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
                        <span class="comments-count-badge">{{ post.comments.count }}</span>
                    </span>
                    <span class="comments-toggle-arrow">‚ñæ</span>
                </button>

                <div class="comments-body hidden"
                     data-post-id="{{ post.id }}">

                    {% for c in post.comments.all %}
                        {% if not c.parent %}
                            {% include "core/partials/comment.html" with c=c user=user liked_comment_ids=liked_comment_ids level=0 %}
                        {% endif %}
                    {% endfor %}

                    {% if user.is_authenticated %}
                        <button type="button"
                                class="comment-add-toggle"
                                data-post-id="{{ post.id }}">
                            –ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>

                        <form method="post"
                              action="{% url 'add_comment' post.id %}"
                              class="comment-form hidden"
                              data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <textarea name="text"
                                      class="comment-input"
                                      placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."
                                      required></textarea>
                            <button type="submit"
                                    class="comment-btn">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>

        </div>
    </div>
</article>
