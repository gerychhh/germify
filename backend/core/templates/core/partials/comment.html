{# core/partials/comment.html #}
{% load tz markdown_extras %}

{% with depth=level %}
<div class="comment-item border rounded-3 p-2 bg-body mt-2
            {% if depth > 0 %}reply-item{% endif %}
            comment-depth-{% if depth > 3 %}3{% else %}{{ depth }}{% endif %}"
     data-comment-id="{{ c.id }}"
     data-post-id="{{ c.post.id }}">

    <!-- HEADER -->
    <div class="comment-header d-flex align-items-start gap-2">
        {% include "core/partials/avatar.html" with user_obj=c.author size="sm" %}

        <div class="comment-author-block d-flex flex-column lh-sm flex-grow-1">
            <div class="comment-author-line d-flex align-items-center gap-1 flex-wrap">
                <a href="{% url 'user_profile' c.author.username %}"
                   class="comment-display-name fw-semibold text-body text-decoration-none">
                    {{ c.author.display_name|default:c.author.username }}
                </a>

                <a href="{% url 'user_profile' c.author.username %}"
                   class="comment-username small text-muted text-decoration-none">
                    @{{ c.author.username }}
                </a>

                {% if c.parent %}
                    <span class="comment-reply-meta small text-muted">
                        –≤ –æ—Ç–≤–µ—Ç @{{ c.parent.author.username }}
                        ¬´{{ c.parent.text|truncatechars:18 }}¬ª
                    </span>
                {% endif %}

                <span class="comment-time small text-muted ms-auto">
                    {{ c.created_at|localtime|date:"d.m.Y H:i" }}
                </span>
            </div>
        </div>
    </div>

    <!-- TEXT -->
    <div class="post-text-block comment-text-block mt-1">
        <div class="post-text-wrapper">
            <div class="comment-text mt-1">{{ c.text|md }}</div>
            <div class="post-text-gradient"></div>
        </div>
        <button type="button"
                class="btn btn-link btn-sm p-0 post-text-toggle hidden">
            –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë
        </button>
    </div>

    <!-- FOOTER -->
    <div class="comment-footer d-flex align-items-center gap-2 flex-wrap small mt-1">
        {% if user.is_authenticated %}
            <form method="post"
                  action="{% url 'toggle_comment_like' c.id %}"
                  class="comment-like-form m-0"
                  data-comment-id="{{ c.id }}">
                {% csrf_token %}
                <button class="comment-like-button btn btn-link p-0 text-decoration-none"
                        type="submit"
                        data-liked="{% if c.id in liked_comment_ids %}true{% else %}false{% endif %}">
                    {% if c.id in liked_comment_ids %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                </button>
            </form>
        {% endif %}

        <span class="comment-like-count text-muted"
              data-comment-id="{{ c.id }}">
            {{ c.likes.count }} –ª–∞–π–∫–æ–≤
        </span>

        {% if user.is_authenticated %}
            <button class="comment-reply-toggle btn btn-link btn-sm p-0 text-decoration-none"
                    type="button"
                    data-comment-id="{{ c.id }}">
                –û—Ç–≤–µ—Ç–∏—Ç—å
            </button>

            {% if c.replies.count %}
                <button class="replies-toggle btn btn-link btn-sm p-0 text-decoration-none"
                        type="button"
                        data-comment-id="{{ c.id }}">
                    –û—Ç–≤–µ—Ç—ã ({{ c.replies.count }})
                </button>
            {% endif %}

            {% if user == c.author or user.is_superuser %}
                <form method="post"
                      action="{% url 'delete_comment' c.id %}"
                      class="comment-delete-form m-0"
                      data-comment-id="{{ c.id }}"
                      data-post-id="{{ c.post.id }}">
                    {% csrf_token %}
                    <button type="submit"
                            class="comment-delete-btn btn btn-link btn-sm p-0 text-decoration-none text-danger">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            {% endif %}
        {% endif %}
    </div>

    {% if user.is_authenticated %}
        <form method="post"
              action="{% url 'add_reply' c.id %}"
              class="reply-form hidden mt-2"
              data-parent-id="{{ c.id }}"
              data-post-id="{{ c.post.id }}">
            {% csrf_token %}
            <textarea name="text"
                      class="form-control reply-input mb-2"
                      placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..."
                      rows="2"
                      required></textarea>
            <button type="submit" class="btn btn-primary btn-sm reply-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
    {% endif %}

    {% if c.replies.exists %}
        <div class="replies-block hidden mt-2 d-flex flex-column gap-1"
             data-parent-id="{{ c.id }}">
            {% for r in c.replies.all %}
                {% include "core/partials/comment.html" with c=r user=user liked_comment_ids=liked_comment_ids level=depth|add:"1" %}
            {% endfor %}
        </div>
    {% endif %}

</div>
{% endwith %}
