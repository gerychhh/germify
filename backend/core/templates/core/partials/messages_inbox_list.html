{% if threads %}
    {% for t in threads %}
        {% with other_user=t.other_user last_message=t.last_message unread=t.unread_count %}
        <div class="dialog-item{% if unread %} has-unread{% endif %}"
             data-search="{{ other_user.username }} {{ other_user.display_name|default:other_user.username }} {{ last_message.text|default_if_none:'' }}">

            <a href="{% url 'messages_thread' other_user.username %}"
               class="dialog-main-link">
                {% include "core/partials/avatar.html" with user_obj=other_user size="sm" %}

                <div class="dialog-main">
                    <div class="dialog-top-row">
                        <span class="dialog-username">
                            {{ other_user.display_name|default:other_user.username }}
                        </span>

                        <div class="dialog-top-right">
                            <span class="dialog-date">
                                {{ last_message.created_at|date:"d.m H:i" }}
                            </span>
                            {% if unread %}
                                <span class="dialog-unread-badge">{{ unread }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="dialog-last-line">
                        <span class="dialog-last-text">
                            {% if last_message.sender_id == request.user.id %}Вы: {% endif %}
                            {{ last_message.text|truncatechars:40 }}
                        </span>
                    </div>
                </div>
            </a>

            <div class="dialog-menu-wrapper">
                <button type="button"
                        class="dialog-menu-toggle"
                        aria-label="Действия с диалогом">
                    ⋯
                </button>

                <div class="dialog-menu">
                    <button type="button"
                            class="dialog-menu-item dialog-menu-item--delete"
                            data-delete-url="{% url 'messages_delete_thread' other_user.username %}"
                            data-username="{{ other_user.username }}">
                        Удалить чат
                    </button>
                </div>
            </div>
        </div>
        {% endwith %}
    {% endfor %}

{% elif conversations %}
    {% for other_user, last_message in conversations.items %}
        <div class="dialog-item"
             data-search="{{ other_user.username }} {{ other_user.display_name|default:other_user.username }} {{ last_message.text|default_if_none:'' }}">

            <a href="{% url 'messages_thread' other_user.username %}"
               class="dialog-main-link">
                {% include "core/partials/avatar.html" with user_obj=other_user size="sm" %}

                <div class="dialog-main">
                    <div class="dialog-top-row">
                        <span class="dialog-username">
                            {{ other_user.display_name|default:other_user.username }}
                        </span>

                        <div class="dialog-top-right">
                            <span class="dialog-date">
                                {{ last_message.created_at|date:"d.m H:i" }}
                            </span>
                        </div>
                    </div>

                    <div class="dialog-last-line">
                        <span class="dialog-last-text">
                            {% if last_message.sender_id == request.user.id %}Вы: {% endif %}
                            {{ last_message.text|truncatechars:40 }}
                        </span>
                    </div>
                </div>
            </a>

            <div class="dialog-menu-wrapper">
                <button type="button"
                        class="dialog-menu-toggle"
                        aria-label="Действия с диалогом">
                    ⋯
                </button>

                <div class="dialog-menu">
                    <button type="button"
                            class="dialog-menu-item dialog-menu-item--delete"
                            data-delete-url="{% url 'messages_delete_thread' other_user.username %}"
                            data-username="{{ other_user.username }}">
                        Удалить чат
                    </button>
                </div>
            </div>
        </div>
    {% endfor %}

{% else %}
    <p class="messages-empty">
        Пока нет ни одного диалога. Откройте профиль пользователя и нажмите «Написать сообщение».
    </p>
{% endif %}
