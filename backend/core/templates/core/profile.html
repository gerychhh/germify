{% extends "core/base.html" %}
{% load tz static %}

{% block title %}Профиль — Germify{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/avatar.css' %}">
<style>
    .profile-page {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .profile-card {
        background: #020617;
        border-radius: 16px;
        border: 1px solid #1e293b;
        padding: 20px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.75);
    }

    .profile-header {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }

    .profile-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .profile-name {
        font-size: 20px;
        font-weight: 600;
        color: #e5e7eb;
    }

    .profile-username {
        font-size: 14px;
        color: #9ca3af;
    }

    .profile-stats {
        display: flex;
        gap: 20px;
        font-size: 14px;
        color: #9ca3af;
    }

    .profile-bio {
        font-size: 15px;
        white-space: pre-line;
        color: #e5e7eb;
        margin-top: 4px;
    }

    .profile-actions {
        margin-top: 10px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .primary-button {
        border: none;
        border-radius: 999px;
        padding: 7px 16px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #022c22;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
    }

    .primary-button:hover {
        filter: brightness(1.1);
    }

    /* Блок редактирования профиля */
    .profile-edit-box {
        margin-top: 10px;
        padding: 15px;
        background: #0f172a;
        border-radius: 12px;
        border: 1px solid #1e293b;
        width: 320px;
    }

    .profile-edit-box form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .form-label {
        font-size: 13px;
        color: #9ca3af;
    }

    .profile-input,
    .profile-textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #1f2937;
        background: #020617;
        padding: 8px 10px;
        font-size: 14px;
        color: #e5e7eb;
    }

    .profile-textarea {
        min-height: 80px;
        resize: vertical;
    }

    .avatar-edit-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .avatar-upload-button {
        position: relative;
        display: inline-block;
        background: #1e40af;
        color: #e5e7eb;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
    }

    .avatar-upload-button:hover {
        background: #1d4ed8;
    }

    /* скрываем сам input[type=file] */
    .avatar-upload-button input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .avatar-preview-img {
        width: 64px;
        height: 64px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid #1f2937;
    }

    .save-profile-btn {
        margin-top: 5px;
        align-self: flex-start;
    }

    .posts-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .post-text,
    .comment-text,
    .reply-text {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }

    @media (max-width: 640px) {
        .profile-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .profile-card {
            padding: 16px;
            border-radius: 14px;
        }

        .profile-username {
            font-size: 18px;
        }

        .profile-bio {
            font-size: 14px;
            line-height: 1.4;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-page">

    <!-- === ПРОФИЛЬ === -->
    <section class="profile-card">
        <div class="profile-header">

            {# большой аватар слева #}
            {% include "core/partials/avatar.html" with user_obj=profile_user size="xl" %}

            <div class="profile-main">

                <div class="profile-name">
                    {{ profile_user.display_name|default:profile_user.username }}
                </div>

                <div class="profile-username">
                    @{{ profile_user.username }}
                </div>

                <div class="profile-stats">
                    <span>
                        <strong class="profile-followers-count">
                            {{ profile_user.followers_count }}
                        </strong> подписчиков
                    </span>
                    <span>
                        <strong>{{ profile_user.following_count }}</strong> подписок
                    </span>
                </div>

                {% if profile_user.bio %}
                    <div class="profile-bio">{{ profile_user.bio }}</div>
                {% endif %}

                <div class="profile-actions">

                    {# --- МОЙ ПРОФИЛЬ --- #}
                    {% if is_owner and form %}
                        <div class="profile-edit-box">
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}

                                <label class="form-label">Отображаемое имя</label>
                                {{ form.display_name }}

                                <label class="form-label">Био</label>
                                {{ form.bio }}

                                <label class="form-label">Аватар</label>
                                <div class="avatar-edit-row">
                                    <label class="avatar-upload-button">
                                        Загрузить аватар
                                        {{ form.avatar }}
                                    </label>

                                    {# одно img для превью: либо текущий, либо спрятанный #}
                                    {% if profile_user.avatar %}
                                        <img src="{{ profile_user.avatar.url }}"
                                             class="avatar-preview-img"
                                             id="avatar-preview">
                                    {% else %}
                                        <img src=""
                                             class="avatar-preview-img"
                                             id="avatar-preview"
                                             style="display:none;">
                                    {% endif %}
                                </div>

                                <button type="submit"
                                        class="primary-button save-profile-btn">
                                    Сохранить
                                </button>
                            </form>
                        </div>
                    {% endif %}

                    {# --- ЧУЖОЙ ПРОФИЛЬ --- #}
                    {% if user.is_authenticated and not is_owner %}
                        <button type="button"
                                class="primary-button follow-btn"
                                data-username="{{ profile_user.username }}"
                                data-follow-url="{% url 'follow_user' profile_user.username %}"
                                data-unfollow-url="{% url 'unfollow_user' profile_user.username %}"
                                data-following="{% if is_following %}1{% else %}0{% endif %}"
                                style="{% if is_following %}background:#1f2937;color:#e5e7eb;{% endif %}">
                            {% if is_following %}Вы подписаны{% else %}Подписаться{% endif %}
                        </button>

                        <a href="{% url 'messages_thread' profile_user.username %}"
                           class="primary-button"
                           style="background:#0f172a;color:#e5e7eb;">
                            Написать сообщение
                        </a>
                    {% endif %}

                </div>
            </div>
        </div>
    </section>

    <!-- === ПОСТЫ === -->
    <section class="profile-card">
        <h2 style="font-size:16px;color:#e5e7eb;margin-bottom:10px;">Посты</h2>

        <div class="posts-list">
            {% for post in posts %}
                {% include "core/partials/post.html" with post=post user=user liked_posts_ids=liked_posts_ids liked_comment_ids=liked_comment_ids following_ids=following_ids %}
            {% empty %}
                <p style="color:#6b7280;">У пользователя пока нет постов.</p>
            {% endfor %}
        </div>
    </section>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.querySelector(".profile-avatar-input");
    const previewImg = document.getElementById("avatar-preview");

    if (!fileInput) return;

    fileInput.addEventListener("change", function () {
        const file = this.files && this.files[0];
        if (!file) return;

        // только картинки
        if (!file.type.startsWith("image/")) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            if (!previewImg) return;
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
        };
        reader.readAsDataURL(file);
    });
});
</script>
{% endblock %}
