{% extends "core/base.html" %}
{% load tz static markdown_extras %}

{% load tz static %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî Germify{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'core/css/shared/attachments.css' %}?v=1">
  <link rel="stylesheet" href="{% static 'core/css/pages/posts/posts.css' %}?v=13">
  <link rel="stylesheet" href="{% static 'core/css/pages/profile/profile.css' %}?v=13">
  <link rel="stylesheet" href="{% static 'core/css/pages/profile/profile_dropdowns.css' %}?v=1">
{% endblock %}

{% block content %}

<div class="container profile-container g-page">
  <div class="profile-page">

    {# ====== HERO ====== #}
    <section class="card profile-hero">
      <div class="card-body profile-hero__body">

        <div class="profile-hero__left">
          <div class="profile-avatar-wrap">
            {% include "core/partials/avatar.html" with user_obj=profile_user size="xl" %}

            {% if user.is_authenticated and user.username == profile_user.username and form %}
              <label id="profileAvatarOverlay" class="profile-avatar-overlay d-none" for="id_avatar" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ">
                <span class="profile-avatar-overlay__icon">üì∑</span>
                <span class="profile-avatar-overlay__text">–ò–∑–º–µ–Ω–∏—Ç—å</span>
              </label>
            {% endif %}
          </div>
        </div>

        <div class="profile-hero__right">
          <div class="d-flex align-items-start justify-content-between gap-2 flex-wrap">
            <div>
              <div class="profile-name-row">
                <div class="profile-name">
                  {{ profile_user.display_name|default:profile_user.username }}
                </div>
                {% if profile_user.is_staff %}
                  <span class="badge text-bg-dark ms-2">admin</span>
                {% endif %}

                {# –ö–∞—Ä–∞–Ω–¥–∞—à —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ—ë–º –ø—Ä–æ—Ñ–∏–ª–µ) #}
                {% if user.is_authenticated and user.username == profile_user.username and form %}
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="profileEditToggle" aria-expanded="false" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                    ‚úèÔ∏è
                  </button>
                {% endif %}
              </div>

              <div class="profile-username">@{{ profile_user.username }}</div>
            </div>

            <div class="profile-actions">
              {# –ß–£–ñ–û–ô –ü–†–û–§–ò–õ–¨: –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è + –°–æ–æ–±—â–µ–Ω–∏–µ #}
              {% if user.is_authenticated and user.username != profile_user.username %}
                <button type="button"
                        class="btn btn-sm {% if is_following %}btn-outline-secondary{% else %}btn-success{% endif %} follow-btn"
                        data-username="{{ profile_user.username }}"
                        data-follow-url="{% url 'follow_user' profile_user.username %}"
                        data-unfollow-url="{% url 'unfollow_user' profile_user.username %}"
                        data-following="{% if is_following %}1{% else %}0{% endif %}">
                  {% if is_following %}–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã{% else %}–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è{% endif %}
                </button>

                <a href="{% url 'messages_thread' profile_user.username %}" class="btn btn-sm btn-outline-primary">
                  –ù–∞–ø–∏—Å–∞—Ç—å
                </a>
              {% endif %}
            </div>
          </div>

          <div class="profile-stats-row d-flex flex-wrap gap-3 align-items-center" data-profile-username="{{ profile_user.username }}">

            <div class="dropdown profile-dd" data-bs-auto-close="outside">
              <button type="button"
                      class="profile-stat-link profile-dd-toggle"
                      data-bs-toggle="dropdown"
                      data-caption="–ü–æ–¥–ø–∏—Å—á–∏–∫–∏"
                      data-url="{% url 'profile_followers_json' profile_user.username %}">
                <strong class="me-1" data-profile-count="followers">{{ profile_user.followers_count }}</strong> –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
              </button>

              <div class="dropdown-menu dropdown-menu-start profile-dd-menu">
                <div class="profile-dd-head p-2 border-bottom">
                  <div class="profile-dd-caption mb-2">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</div>
                  <input type="search" class="form-control form-control-sm profile-dd-search" placeholder="–ü–æ–∏—Å–∫...">
                </div>
                <div class="profile-dd-list"></div>
                <div class="profile-dd-empty p-3 text-muted small d-none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>

            <div class="dropdown profile-dd" data-bs-auto-close="outside">
              <button type="button"
                      class="profile-stat-link profile-dd-toggle"
                      data-bs-toggle="dropdown"
                      data-caption="–ü–æ–¥–ø–∏—Å–∫–∏"
                      data-url="{% url 'profile_following_json' profile_user.username %}">
                <strong class="me-1" data-profile-count="following">{{ profile_user.following_count }}</strong> –ø–æ–¥–ø–∏—Å–æ–∫
              </button>

              <div class="dropdown-menu dropdown-menu-start profile-dd-menu">
                <div class="profile-dd-head p-2 border-bottom">
                  <div class="profile-dd-caption mb-2">–ü–æ–¥–ø–∏—Å–∫–∏</div>
                  <input type="search" class="form-control form-control-sm profile-dd-search" placeholder="–ü–æ–∏—Å–∫...">
                </div>
                <div class="profile-dd-list"></div>
                <div class="profile-dd-empty p-3 text-muted small d-none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>

            <div class="dropdown profile-dd" data-bs-auto-close="outside">
              <button type="button"
                      class="profile-stat-link profile-dd-toggle"
                      data-bs-toggle="dropdown"
                      data-caption="–°–æ–æ–±—â–µ—Å—Ç–≤–∞"
                      data-url="{% url 'profile_communities_admin_json' profile_user.username %}">
                <strong class="me-1" data-profile-count="communities_admin">{{ communities_admin_count|default:0 }}</strong> —Å–æ–æ–±—â–µ—Å—Ç–≤
              </button>

              <div class="dropdown-menu dropdown-menu-start profile-dd-menu">
                <div class="profile-dd-head p-2 border-bottom">
                  <div class="profile-dd-caption mb-2">–°–æ–æ–±—â–µ—Å—Ç–≤–∞</div>
                  <input type="search" class="form-control form-control-sm profile-dd-search" placeholder="–ü–æ–∏—Å–∫...">
                </div>
                <div class="profile-dd-list"></div>
                <div class="profile-dd-empty p-3 text-muted small d-none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>

            <div class="dropdown profile-dd" data-bs-auto-close="outside">
              <button type="button"
                      class="profile-stat-link profile-dd-toggle"
                      data-bs-toggle="dropdown"
                      data-caption="–ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞"
                      data-url="{% url 'profile_communities_joined_json' profile_user.username %}">
                <strong class="me-1" data-profile-count="communities_joined">{{ communities_joined_count|default:0 }}</strong> –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
              </button>

              <div class="dropdown-menu dropdown-menu-start profile-dd-menu">
                <div class="profile-dd-head p-2 border-bottom">
                  <div class="profile-dd-caption mb-2">–ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</div>
                  <input type="search" class="form-control form-control-sm profile-dd-search" placeholder="–ü–æ–∏—Å–∫...">
                </div>
                <div class="profile-dd-list"></div>
                <div class="profile-dd-empty p-3 text-muted small d-none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
              </div>
            </div>

          </div>

          {# ===== BIO VIEW ===== #}
          <div id="profileBioView" class="profile-bio-view">
            {% if profile_user.bio %}
              <div class="profile-bio post-text">{{ profile_user.bio|md }}</div>
            {% else %}
              <div class="profile-bio profile-bio--empty">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è.</div>
            {% endif %}
          </div>

          {# ===== EDIT PANEL (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ===== #}
          {% if user.is_authenticated and user.username == profile_user.username and form %}
            <div id="profileEditPanel" class="profile-edit-panel d-none">
              <form method="post" enctype="multipart/form-data" class="profile-edit-form">
                {% csrf_token %}

                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                    {{ form.display_name }}
                  </div>
                  <div class="col-12">
                    <label class="form-label">–û —Å–µ–±–µ</label>
                    {{ form.bio }}
                  </div>
                </div>

                <div class="d-none">
                  {{ form.avatar }}
                </div>

                <div class="d-flex gap-2 mt-2">
                  <button type="submit" class="btn btn-success btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="profileEditCancel">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </form>
            </div>
          {% endif %}

        </div>
      </div>
    </section>

    {# ====== POSTS ====== #}
    <div class="feed-page">
      <section class="card">
        <div class="card-header bg-white">
          <div class="d-flex align-items-center justify-content-between">
            <div class="fw-semibold">–ü–æ—Å—Ç—ã</div>
            <span class="badge text-bg-light">{{ posts|length }}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="posts-list d-flex flex-column gap-3">
            {% for post in posts %}
              {% include "core/partials/post.html" with post=post user=user liked_posts_ids=liked_posts_ids liked_comment_ids=liked_comment_ids following_ids=following_ids %}
            {% empty %}
              <div class="text-body-secondary">–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.</div>
            {% endfor %}
          </div>
        </div>
      </section>
    </div>

  </div>
</div>

<script src="{% static 'core/js/profile_dropdowns.js' %}?v=3" defer></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggleBtn = document.getElementById('profileEditToggle');
  const cancelBtn = document.getElementById('profileEditCancel');
  const panel = document.getElementById('profileEditPanel');
  const bioView = document.getElementById('profileBioView');
  const overlay = document.getElementById('profileAvatarOverlay');

  const fileInput = document.querySelector('.profile-avatar-input');
  const avatarWrap = document.querySelector('.profile-avatar-wrap .avatar');

  function setEditing(isEditing) {
    if (!panel || !bioView || !toggleBtn) return;
    panel.classList.toggle('d-none', !isEditing);
    bioView.classList.toggle('d-none', isEditing);
    toggleBtn.setAttribute('aria-expanded', isEditing ? 'true' : 'false');
    if (overlay) overlay.classList.toggle('d-none', !isEditing);
    document.body.classList.toggle('profile-is-editing', isEditing);

    if (isEditing) {
      const bioField = document.getElementById('id_bio');
      if (bioField) bioField.focus();
    }
  }

  if (toggleBtn) {
    toggleBtn.addEventListener('click', function () {
      const isOpen = panel && !panel.classList.contains('d-none');
      setEditing(!isOpen);
    });
  }

  if (cancelBtn) {
    cancelBtn.addEventListener('click', function () {
      setEditing(false);
      if (fileInput) fileInput.value = '';
    });
  }

  if (fileInput && avatarWrap) {
    fileInput.addEventListener('change', function () {
      const file = this.files && this.files[0];
      if (!file) return;
      if (!file.type || !file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const url = e.target.result;
        let img = avatarWrap.querySelector('img');
        const initial = avatarWrap.querySelector('.avatar-initial');
        if (!img) {
          img = document.createElement('img');
          img.alt = 'avatar';
          avatarWrap.appendChild(img);
        }
        img.src = url;
        if (initial) initial.style.display = 'none';
      };
      reader.readAsDataURL(file);
    });
  }
});
</script>

{% endblock %}