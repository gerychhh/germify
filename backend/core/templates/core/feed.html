{% extends "core/base.html" %}
{% load static tz %}

{% block title %}–õ–µ–Ω—Ç–∞ ‚Äî Germify{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'core/css/shared/attachments.css' %}?v=1">
    <link rel="stylesheet" href="{% static 'core/css/pages/posts/posts.css' %}?v=13">

    {# UI polish just for feed search + composer #}
    <style>
        /* --- Search --- */
        .feed-search-card{
            border-radius: 18px;
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 2px 10px rgba(0,0,0,.05);
            overflow: hidden;
        }
        .feed-search-form{ width: 100%; }
        .feed-search-pill{
            display:flex;
            align-items:center;
            gap:.5rem;
            padding:.55rem .6rem;
            border: 1px solid rgba(0,0,0,.12);
            border-radius: 999px;
            background: rgba(255,255,255,.9);
        }
        .feed-search-pill:focus-within{
            border-color: rgba(13,110,253,.50);
            box-shadow: 0 0 0 .25rem rgba(13,110,253,.15);
        }
        .feed-search-icon{
            opacity:.65;
            padding-left:.25rem;
            user-select:none;
        }
        .feed-search-input{
            border: 0 !important;
            outline: 0 !important;
            box-shadow: none !important;
            flex: 1 1 auto;
            min-width: 220px;
            background: transparent !important;
            padding: .15rem .25rem;
        }
        .feed-search-btn{
            border-radius: 999px;
            padding: .38rem .95rem;
            white-space: nowrap;
        }
        .feed-search-clear{
            border-radius: 999px;
            padding: .38rem .75rem;
            text-decoration: none;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            white-space: nowrap;
        }

        /* --- Composer --- */
        .feed-new-post-card{
            border-radius: 18px;
            border: 1px solid rgba(0,0,0,.08);
            box-shadow: 0 2px 10px rgba(0,0,0,.05);
            overflow: hidden;
        }
        .feed-new-post-textarea{
            border-radius: 14px;
            padding: .8rem .95rem;
            resize: vertical;
        }
        .feed-new-post-textarea:focus{
            border-color: rgba(13,110,253,.45);
            box-shadow: 0 0 0 .25rem rgba(13,110,253,.15);
        }
        .file-info span{
            background: rgba(0,0,0,.04);
            border: 1px solid rgba(0,0,0,.08);
            padding: .20rem .55rem;
            border-radius: 999px;
        }
        .feed-new-post-footer .btn{
            border-radius: 999px;
            padding-left: .9rem;
            padding-right: .9rem;
        }

        @media (max-width: 576px){
            .feed-search-input{ min-width: 140px; }
        }
    </style>
{% endblock %}

{% block content %}
<div class="feed-page">

    <!-- –ü–æ–∏—Å–∫ –ø–æ –ª–µ–Ω—Ç–µ -->
    <section class="card feed-search-card">
        <div class="card-body p-3">
            <form method="get" action="{% url 'feed' %}" class="feed-search-form">
                <div class="feed-search-pill">
                    <span class="feed-search-icon">üîé</span>

                    <input
                        type="search"
                        name="q"
                        value="{{ q|default:'' }}"
                        class="form-control feed-search-input"
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ—Å—Ç–æ–≤‚Ä¶ (–º–æ–∂–Ω–æ @username –∏–ª–∏ –∏–º—è –∞–≤—Ç–æ—Ä–∞)"
                        autocomplete="off">

                    <button type="submit" class="btn btn-success feed-search-btn">–ù–∞–π—Ç–∏</button>

                    {% if q %}
                        <a class="btn btn-outline-secondary feed-search-clear" href="{% url 'feed' %}" title="–°–±—Ä–æ—Å–∏—Ç—å">‚úï</a>
                    {% endif %}
                </div>
            </form>

            {% if q_author %}
                <div class="small text-muted mt-2">
                    –§–∏–ª—å—Ç—Ä –ø–æ –∞–≤—Ç–æ—Ä—É:
                    <strong>@{{ q_author.username }}</strong>{% if q_author.display_name %} ({{ q_author.display_name }}){% endif %}
                </div>
            {% endif %}
        </div>
    </section>

    <!-- –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞ -->
    <section class="card feed-new-post-card">
        <div class="card-body p-3">
            <form method="post"
                  action="{% url 'create_post' %}"
                  class="new-post-form"
                  enctype="multipart/form-data"
                  data-authenticated="{% if user.is_authenticated %}1{% else %}0{% endif %}"
                  data-login-url="{% url 'login' %}?next={{ request.path }}">
                {% csrf_token %}
                <h2 class="h6 mb-2 feed-new-post-title">–ß–µ–º –ø–æ–¥–µ–ª–∏—à—å—Å—è —Å–µ–≥–æ–¥–Ω—è?</h2>

                <textarea
                    name="text"
                    class="form-control feed-new-post-textarea"
                    rows="4"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ.">{% if form.text.value %}{{ form.text.value }}{% endif %}</textarea>

                <!-- PREVIEW -->
                <div class="file-preview mt-2" id="file-preview"></div>

                <!-- PREVIEW –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ -->
                <audio id="voice-preview"
                       class="voice-preview hidden mt-2 w-100"
                       controls></audio>

                <!-- DRAG & DROP ZONE -->
                <div id="drop-zone" class="drop-zone hidden mt-2 p-3 rounded text-center">
                    –ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏ –Ω–∞ —Å–∫—Ä–µ–ø–∫—É
                </div>

                <!-- INFO + PROGRESS -->
                <div class="file-info small text-muted mt-2 d-flex gap-2 flex-wrap">
                    <span id="file-count">–§–∞–π–ª—ã: 0</span>
                    <span id="file-size">–†–∞–∑–º–µ—Ä: 0 MB</span>
                </div>

                <div class="upload-progress hidden mt-2" id="upload-progress">
                    <div class="upload-progress-bar" id="upload-progress-bar"></div>
                </div>

                <div class="feed-new-post-footer mt-3 d-flex align-items-center gap-2 flex-wrap">
                    <!-- –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ -->
                    <div class="voice-recorder d-flex align-items-center gap-2 me-auto">
                        <button type="button"
                                id="voice-record-btn"
                                class="btn btn-outline-primary btn-sm voice-record-btn">
                            üéô –ì–æ–ª–æ—Å
                        </button>
                        <span id="voice-record-status" class="voice-record-status small text-muted"></span>
                    </div>

                    <label class="btn btn-outline-secondary btn-sm attach-btn mb-0" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã">
                        üìé <span class="d-none d-sm-inline">–§–∞–π–ª—ã</span>
                        <input type="file"
                               name="attachments"
                               multiple
                               style="display:none;">
                    </label>

                    <button type="submit" class="btn btn-primary btn-sm primary-button">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </section>

    <!-- –õ–µ–Ω—Ç–∞ –ø–æ—Å—Ç–æ–≤ -->
    <section class="posts-list d-flex flex-column gap-3"
             id="posts-list"
             data-next-page="{% if has_next %}{{ next_page }}{% else %}0{% endif %}"
             data-has-next="{% if has_next %}1{% else %}0{% endif %}">
        {% for post in posts %}
            {% include "core/partials/post.html" with post=post user=user liked_posts_ids=liked_posts_ids liked_comment_ids=liked_comment_ids following_ids=following_ids %}
        {% empty %}
            {% if q %}
                <div class="card">
                    <div class="card-body p-3 text-muted">
                        –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É <strong>‚Äú{{ q }}‚Äù</strong>.
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </section>

    <div class="feed-loading" id="feed-loading" style="display:none;">
        –ó–∞–≥—Ä—É–∑–∫–∞ –µ—â—ë –ø–æ—Å—Ç–æ–≤...
    </div>

</div>
{% endblock %}
