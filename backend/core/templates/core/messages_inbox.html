{% extends "core/base.html" %}

{% block title %}Сообщения — Germify{% endblock %}

{% block extra_head %}
<style>
    .dialogs-wrapper {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
    }

    .dialog-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        text-decoration: none;
        background: #020617;
        border: 1px solid #111827;
        transition: background .15s ease, border-color .15s ease, transform .1s ease;
    }

    .dialog-item:hover {
        background: #020617;
        border-color: #1f2937;
        transform: translateY(-1px);
    }

    .dialog-avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 30%, #22c55e, #16a34a);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 18px;
        color: #022c22;
        flex-shrink: 0;
    }

    .dialog-main {
        display: flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
        width: 100%;
    }

    .dialog-top-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: baseline;
    }

    .dialog-username {
        font-size: 14px;
        font-weight: 600;
        color: #e5e7eb;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dialog-date {
        font-size: 12px;
        color: #6b7280;
        white-space: nowrap;
    }

    .dialog-last-line {
        font-size: 13px;
        color: #9ca3af;
        display: flex;
        gap: 4px;
        min-width: 0;
    }

    .dialog-last-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .messages-empty {
        margin-top: 8px;
        font-size: 14px;
        color: #6b7280;
    }

    .messages-header h1 {
        margin: 0 0 4px;
        font-size: 22px;
    }

    .messages-subtitle {
        margin: 0;
        font-size: 14px;
        color: #9ca3af;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <section class="messages-header">
        <h1>Сообщения</h1>
        <p class="messages-subtitle">
            Выберите диалог или откройте профиль пользователя, чтобы начать переписку.
        </p>
    </section>

    <section class="dialogs-wrapper">
        {% if conversations %}
            {# conversations: other_user -> last_message #}
            {% for other_user, last_message in conversations.items %}
                <a href="{% url 'messages_thread' other_user.username %}" class="dialog-item">
                    <div class="dialog-avatar-circle">
                        {{ other_user.display_name|default:other_user.username|first|upper }}
                    </div>

                    <div class="dialog-main">
                        <div class="dialog-top-row">
                            <span class="dialog-username">
                                {{ other_user.display_name|default:other_user.username }}
                            </span>
                            <span class="dialog-date">
                                {{ last_message.created_at|date:"d.m.Y H:i" }}
                            </span>
                        </div>

                        <div class="dialog-last-line">
                            <span>
                                {% if last_message.sender == user %}Вы:{% else %}{{ last_message.sender.display_name|default:last_message.sender.username }}:{% endif %}
                            </span>
                            <span class="dialog-last-text">
                                {{ last_message.text|truncatechars:60 }}
                            </span>
                        </div>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <p class="messages-empty">
                Пока нет ни одного диалога. Откройте профиль пользователя и нажмите «Написать сообщение».
            </p>
        {% endif %}
    </section>
</div>
{% endblock %}
