{% with other_user=t.other_user last_message=t.last_message unread=t.unread_count %}
<div class="dialog-item{% if unread %} has-unread{% endif %}"
     data-username="{{ other_user.username }}"
     data-unread="{{ unread|default:0 }}"
     data-search="{{ other_user.username|lower }} {% if other_user.display_name %}{{ other_user.display_name|lower }}{% endif %}">

    <a href="{% url 'messages_thread' other_user.username %}"
       class="dialog-main-link">
        {% include "core/partials/avatar.html" with user_obj=other_user size="xs" %}
        <div class="dialog-main">
            <div class="dialog-top-row">
                <span class="dialog-username">
                    {{ other_user.display_name|default:other_user.username }}
                </span>
                <div class="dialog-top-right">
                    <span class="dialog-date">
                        {{ last_message.created_at|date:"d.m.Y H:i" }}
                    </span>
                    {% if unread %}
                        <span class="dialog-unread-badge">
                            {{ unread }}
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="dialog-last-line">
                <span>
                    {% if last_message.sender == request.user %}
                        Вы:
                    {% else %}
                        {{ last_message.sender.display_name|default:last_message.sender.username }}:
                    {% endif %}
                </span>
                <span class="dialog-last-text">
                    {{ last_message.text|truncatechars:60 }}
                </span>
            </div>
        </div>
    </a>

    <div class="dialog-menu-wrapper">
        <button type="button"
                class="dialog-menu-toggle"
                aria-label="Действия с диалогом">
            ⋯
        </button>

        <div class="dialog-menu">
            <button type="button"
                    class="dialog-menu-item dialog-menu-item--delete"
                    data-username="{{ other_user.username }}"
                    data-delete-url="{% url 'messages_delete_thread' other_user.username %}">
                Удалить чат
            </button>
        </div>
    </div>
</div>
{% endwith %}
